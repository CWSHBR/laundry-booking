# Laundry Schedule Bot (Telegram + Kotlin + SQLite)

Телеграм-бот для планирования расписания прачечной.

Возможности:
- Регистрация пользователя (фамилия + номер комнаты) при первом запуске.
- Выбор машины и свободного часа через inline-клавиатуры.
- Ограничение: на один день пользователь может занять одну и ту же машину не более чем на 1 час.
- Админ-меню: добавление машин (название, часы работы), управление расписанием (удаление/назначение броней), добавление администраторов по Telegram ID.

Технологии:
- Kotlin/JVM, Gradle, TelegramBots 6.8.0
- SQLite (файл `laundry.db` в рабочей директории)
- SLF4J (simple)

## Быстрый старт

Требования: JDK 21 (Gradle wrapper подтянет нужный toolchain), доступ к интернету для загрузки зависимостей.

1) Собрать проект:

```zsh
./gradlew clean build -x test
```

2) Установить переменные окружения:
- `BOT_TOKEN` — токен бота от @BotFather (или `TELEGRAM_BOT_TOKEN`)
- `PRIMARY_ADMIN_ID` — Telegram user id первичного администратора (или `TELEGRAM_PRIMARY_ADMIN_ID`). Этот пользователь получит доступ к админ-меню.

Пример (zsh):

```zsh
export BOT_TOKEN="123456:ABC-DEF..."
export PRIMARY_ADMIN_ID="123456789"
```

3) Запустить бота из Gradle:

```zsh
./gradlew run
```

Либо собрать дистрибутив и запускать бинарник:

```zsh
./gradlew installDist
./build/install/laundry-schedule/bin/laundry-schedule
```

По умолчанию БД будет в файле `laundry.db` в текущей директории.

## Как пользоваться

- Пользователь:
  - Отправьте `/start`. Если вы не зарегистрированы — бот попросит ввести: `Фамилия НомерКомнаты` (например, `Иванов 123`).
  - В главном меню нажмите «Выбрать машину», затем выберите дату и свободный час (помечен ✅).
  - Бронь создаётся на 1 час. На одну и ту же машину в пределах одного дня больше одного часа забронировать нельзя.

- Администратор:
  - Отправьте `/admin`.
  - «Машины» — добавление новой машины (название, часы работы в диапазонах 0–24) и просмотр расписания по дням. В расписании:
    - Нажмите на ❌, чтобы удалить существующую запись.
    - Нажмите на ✅, чтобы назначить слот — бот попросит ввести Telegram ID пользователя, на которого оформить бронь.
  - «Администраторы» — посмотреть список и добавить нового админа по Telegram ID.

## Структура пакетов

- `ru.bshaykhraziev.laundryschedule.bot` — Telegram-бот, обработка команд и inline-клавиатур.
- `ru.bshaykhraziev.laundryschedule.db` — инициализация БД и миграции.
- `ru.bshaykhraziev.laundryschedule.model` — доменные модели.
- `ru.bshaykhraziev.laundryschedule.repo` — доступ к данным (users, admins, machines, bookings).
- `ru.bshaykhraziev.laundryschedule.service` — сервисный слой и бизнес-логика.

## Замечания

- Время задаётся в часах: машина работает в интервале [openHour, closeHour). Например, 8–22 означает слоты 8..21.
- Миграции выполняются автоматически при старте.
- Для простоты диалоги добавления машин/админов реализованы через in-memory состояния; при перезапуске бота незавершённые шаги сбрасываются.

## Траблшутинг

- Ошибка при запуске: "Env BOT_TOKEN ... не задан" — установите переменные окружения `BOT_TOKEN` и `PRIMARY_ADMIN_ID`.
- Если бот не отвечает — проверьте, что токен корректен и у процесса есть выход в интернет. Также убедитесь, что бот не запущен второй копией.
- SQLite-файл блокируется на запись другим процессом — остановите вторую копию бота или закройте приложение, использующее `laundry.db`.

